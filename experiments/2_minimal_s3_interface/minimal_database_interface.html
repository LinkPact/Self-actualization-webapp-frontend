<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S3 test</title>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.813.0.min.js"></script>
</head>
<body>

<h1>Minimal database interface</h1>

<p>Required content</p>

<ul>
    <li>Add new single-name entries</li>
    <li>Sync with database on click</li>
    <li>Load from database on click</li>
    <li>Show currently loaded data</li>
</ul>

<div>
    <div>
        <label for="goal_input">Test </label><input type="text" id="goal_input" name="Input goal name">
        <button onclick="newEntryClick(document.getElementById('goal_input').value)">Add new entry</button>
    </div>
    <div><button onclick="sendToDatabaseClick()">Upload to database</button></div>
    <div><button onclick="loadFromDatabaseClick()">Retrieve from database</button></div>
    <div><button onclick="resetDatabase()">Reset database</button></div>
</div>

<div>
    <h3>Current goals</h3>
    <ul id="habits_list">
        <li>Placeholder</li>
    </ul>
</div>

<script>
    const s3BucketName = 'selfactualizationtest';
    const jsonPath = 'testDb.json';

    // Setup identity pool
    AWS.config.region = 'eu-north-1'; // Region
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: 'eu-north-1:51a3d198-8df4-48b0-bc86-61e12f4539d9',
    });

    // Access S3 bucket using the anonymous credentials
    const s3 = new AWS.S3({
        params: {Bucket: s3BucketName, Key: "user1.json"}
    });

    function getTextFromS3Object(bucketName, objName) {
        return s3.getObject({
            Bucket: bucketName,
            Key: objName
        }, function(err, data) {
            if (err) {
                console.log(err)
            }
            else {
                console.log("From request: ", data.Body.toString('ascii'));
            }
        })
    }

    function getS3JSON(bucketName, objName) {
        return s3.getObject({
            Bucket: bucketName,
            Key: objName
            // Key: "user1.json"
        }, function(err, data) {
            if (err) {
                console.log(objName + " not found!")
            } else {
                const jsonRaw = data.Body.toString('ascii');
                console.log(jsonRaw);
                console.log(jsonRaw[0]);
                const jsonObj = JSON.parse(jsonRaw);
                console.log(jsonObj);
                return jsonObj;
            }
        });
    }

    const loadedEntries = ["Health", "Usefulness"];
    getS3JSON(s3BucketName, "test.json");

    s3.putObject({
       Bucket: s3BucketName,
       Key: "test.json",
        ContentType:'text/plain',
        Body: JSON.stringify(loadedEntries)
    }, function(err, data) {
        if (err) {
            console.log(err);
        } else {
            console.log("Testing putting object");
        }
    });

    function newEntryClick(newEntry) {
        console.log("New entry clicked");
        loadedEntries.push(newEntry);
        updateHabitsDisplay();
    }

    function sendToDatabaseClick() {
        console.log("Sending to database");
    }

    function loadFromDatabaseClick() {
        console.log("Loading from database");
        updateHabitsDisplay();
    }

    // https://stackoverflow.com/questions/43376270/how-to-dynamically-populate-a-list-on-an-html-page
    function updateHabitsDisplay() {
        const listElem = document.getElementById("habits_list");
        listElem.innerHTML = "";

        loadedEntries.forEach(function(entry) {
            const newItem = document.createElement('li');
            newItem.appendChild(document.createTextNode(entry));
            listElem.appendChild(newItem);
        });
    }

    function resetDatabase() {
        console.log("Reset database");
    }

    window.onload = function() {
        updateHabitsDisplay();
    }
</script>

</body>
</html>